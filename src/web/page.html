<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <style>
    body {
      display: flex;
      margin: 0;
      padding: 0;
      height: 100vh;
    }

    #video-container {
      flex: 1;
      background-color: #f0f0f0;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #config-container {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .config-group {
      border-bottom: 2px solid #ddd;
      padding: 10px 0;
      justify-content: left;
      column-gap: 20px;
    }

    .config-group:last-child {
      border-bottom: none;
    }

    .input-wrapper {
      position: relative;
      display: inline-block;
    }

    .input-wrapper input {
      text-align: right;
      padding-right: 20px;
      /* Make space for the symbol */
    }

    .input-wrapper span {
      position: absolute;
      right: 5px;
      /* Adjust based on padding and preferences */
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      /* Makes it non-interactive */
    }


    #gridCanvas {
      display: "none";
      position: absolute;
      width: 500px;
      height: 500px;
    }

    .cell {
      width: 15.6px;
      /* 320px / 32 cells */
      height: 15.6px;
      float: left;
      border: 1px solid #dddddd57;
      box-sizing: border-box;
      cursor: pointer;
    }

    .toggled {
      background-color: rgba(255, 0, 0, 0.338);
    }
  </style>


  <title>Detection preview & config</title>
</head>

<body id="body" onload="start()">

  <div id="video-container">
    <img id="stream" alt="Image cannot be displayed" />
    <div id="gridCanvas"></div>
  </div>

  <div id="config-container">

    <div class="config-group">
      <label for="image-rotation" class="input-label">Device rotation:</label>
      <select name="image-rotation" id="image-rotation">
        <option value=0>0째</option>
        <option value=90>90째</option>
        <option value=180>180째</option>
        <option value=270>270째</option>
      </select>
    </div>

    <div class="config-group">
      <label for="jpeg-quality">Preview quality:</label>
      <input type="number" id="jpeg-quality" name="jpeg-quality" size="3" maxlength="3" min="5" max="100">
      <label for="preview-size">Preview size:</label>
      <div class="input-wrapper">
        <input type="number" id="preview-size" name="preview-size" onchange="resizePreview()" size="4" maxlength="4" min="200" max="1000">
        <span>px</span>
      </div>
    </div>

    <div class="config-group">
      <label for="mask-size">Mask size:</label>
      <input type="number" id="mask-size" name="mask-size" onchange="resizeMask()" size="3" maxlength="3" min="2" max="80">

      <label for="mask-thresh">Uncovered threshold:</label>
      <div class="input-wrapper">
        <input type="number" id="mask-thresh" name="mask-thresh" size="3" maxlength="3" min="0" max="100">
        <span>%</span>
      </div>
      <button id="toggleMaskBtn" onclick="toggleMask()">Toggle mask</button>
      <button id="resetMaskBtn" onclick="resetMask()">Reset mask</button>
    </div>

    <div class="config-group">
      <label for="det-thresh">Detection threshold:</label>
      <div class="input-wrapper">
        <input type="number" id="det-thresh" name="det-thresh" size="3" maxlength="3" min="0" max="100">
        <span>%</span>
      </div>

      <label for="iou-thresh">Detection overlap threshold:</label>
      <div class="input-wrapper">
        <input type="number" id="iou-thresh" name="iou-thresh" size="3" maxlength="3" min="0" max="100">
        <span>%</span>
      </div>
    </div>

    <div class="config-group">
      <label for="fp-change">False-positive change threshold:</label>
      <div class="input-wrapper">
        <input type="number" id="fp-change" name="fp-change" size="3" maxlength="3" min="0" max="100" />
        <span>%</span>
      </div>

      <label for="fp-count">False-positive count threshold:</label>
      <div class="input-wrapper">
        <input type="number" id="fp-count" name="fp-count" size="3" maxlength="3" min="0" max="100">
        <span>%</span>
      </div>
      <br>
      <br>
      <label for="min-width">False-positive min width:</label>
      <div class="input-wrapper">
        <input type="number" id="min-width" name="min-width" size="3" maxlength="3" min="0" max="320">
        <span>px</span>
      </div>

      <label for="min-height">False-positive min height:</label>
      <div class="input-wrapper">
        <input type="number" id="min-height" name="min-height" size="3" maxlength="3" min="0" max="320">
        <span>px</span>
      </div>

      <label for="min-as-area">Treat as area:</label>
      <input type="checkbox" id="min-as-area" name="min-as-area">
    </div>

    <div class="config-group">
      <button id="saveToDevice" onclick="saveConfig()">Save config</button>
      <button id="loadFromDevice" onclick="loadConfig()">Load config</button>
      <button id="resetFromDevice" onclick="resetConfig()">Reset config</button>
    </div>

    <div class="config-group">
      <button id="saveToFileBtn" onclick="downloadConfig()">Download configuration</button>
      <input type="file" id="file-input" style="display: none;" onchange="uploadConfig()" />
      <button id="loadFromFileBtn" onclick="document.getElementById('file-input').click()">Upload configuration</button>
    </div>

    <div class="config-group">
      <label for="status-field">Status:</label>
      <input type="number" id="status-field" name="status-field" size="1" maxlength="1" disabled>
    </div>

  </div>


  <script>
    const imgUrl         = "/camera_stream"; //get
    const configSaveUrl  = "/config_save"; //get set
    const configLoadUrl  = "/config_load"; //get set
    const configResetUrl = "/config_reset";
    const statusUrl      = "/detection_status";

    var previewSize = 500;
    var maskSize    = 32; //current mask size (cell count per dimension)
    var maskThresh  = 50;
    var rotation    = 270;
    var detThresh   = 50;
    var iouThresh   = 50;
    var fpChange    = 0;
    var fpCount     = 0;
    var jpegQuality = 70;
    var minWidth    = 0;
    var minHeight   = 0;
    var minAsArea   = false;

    var mask;
    var mouseIsDown = false; //Tracks if the mouse is pressed down
    var toggleDir   = 0;


    //start everything important on load
    function start() {
      updateElements()
      loadConfig();
      updatePreview();
    }


    //Post data to device
    function postData(url, type, data) {
      return fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": type,
        },
        body: data
      })
        .then(response => {
          if (!response.ok) {
            console.error("Post not OK (", response.status, "): ", response.statusText);
            throw new Error("Post not ok");
          }
          else
            console.log("Post OK (", response.status, ")");
          return response.text();
        })
        .then(body => {
          console.log("Success: ", body)
        })
        .catch(error => console.error("Error: ", error))
    }

    //Get data from device
    function getData(url, isJson) {
      return fetch(url)
        .then(response => {
          //Check if the response is ok (status code 200-299)
          if (!response.ok) {
            console.error("Get not OK (", response.status, "): ", response.statusText);
            return Promise.reject("Get not OK");
          }
          else
            console.log("Get OK (", response.status, ")");
          return isJson ? response.json() : response.text();
        })
        .catch(error => {
          console.error("Get error: ", error)
          return Promise.reject(error);
        });
    }


    function clamp(val, min, max) {
      if (val < min)
        return min;
      if (val > max)
        return max;
      return val;
    }


    function updateElements() {
      document.getElementById("mask-size").value       = maskSize;
      document.getElementById("mask-thresh").value     = maskThresh;
      document.getElementById("image-rotation").value  = rotation;
      document.getElementById("det-thresh").value      = detThresh;
      document.getElementById("iou-thresh").value      = iouThresh;
      document.getElementById("fp-change").value       = fpChange;
      document.getElementById("fp-count").value        = fpCount;
      document.getElementById("jpeg-quality").value    = jpegQuality;
      document.getElementById("preview-size").value    = previewSize;
      document.getElementById("min-width").value       = minWidth;
      document.getElementById("min-height").value      = minHeight;
      document.getElementById("min-as-area").checked   = minAsArea;
    }

    //Update all required elements
    function updateDocument(values) {
      if (values.length < 11)
        throw Error("Invalid csv length of ", values.length);
      maskSize = clamp(Number(values[0]), 2, 80);
      createMask();
      maskThresh = clamp(values[1], 0, 100);
      for (var i = 0; i < maskSize; i++) {
        for (var ii = 0; ii < maskSize; ii++) {
          mask.val[i][ii] = Number(values[2][i * maskSize + ii]);
          toggleDir = mask.val[i][ii];
          toggleCell(i, ii);
        }
      }
      rotation    = clamp(Number(values[3]),  0, 270);
      detThresh   = clamp(Number(values[4]),  0, 100);
      iouThresh   = clamp(Number(values[5]),  0, 100);
      fpChange    = clamp(Number(values[6]),  0, 100);
      fpCount     = clamp(Number(values[7]),  0, 100);
      jpegQuality = clamp(Number(values[8]),  5, 100);
      minWidth    = clamp(Number(values[9]),  0, 320);
      minHeight   = clamp(Number(values[10]), 0, 320);
      minAsArea   = clamp(Number(values[11]), 0, 1) ? true : false;

      updateElements()
    }

    //load configuration from device
    function loadConfig() {
      getData(configLoadUrl, false)
        .then(config => {
          console.log("Config loaded");
          updateDocument(config.split(","));
        })
        .catch(error => console.error("Failed to load config: ", error));
    }

    //Build csv from local configuration
    function csvFromConfig() {
      let maskVal = "";
      mask.val.forEach(row => {
        row.forEach(item => {
          maskVal += item.toString();
        })
      })
      var csv = maskSize.toString() + ",";
      csv += maskThresh.toString()  + ",";
      csv += maskVal                + ",";
      csv += rotation.toString()    + ",";
      csv += detThresh.toString()   + ",";
      csv += iouThresh.toString()   + ",";
      csv += fpChange.toString()    + ",";
      csv += fpCount.toString()     + ",";
      csv += jpegQuality.toString() + ',';
      csv += minWidth.toString()    + ',';
      csv += minHeight.toString()   + ',';
      csv += minAsArea ? '1' : '0';
      return csv;
    }

    //Send and save current configuration to device
    function saveConfig() {
      maskSize    = clamp(document.getElementById("mask-size").value,      2, 80);
      maskThresh  = clamp(document.getElementById("mask-thresh").value,    0, 100);
      rotation    = clamp(document.getElementById("image-rotation").value, 0, 270);
      detThresh   = clamp(document.getElementById("det-thresh").value,     0, 100);
      iouThresh   = clamp(document.getElementById("iou-thresh").value,     0, 100);
      fpChange    = clamp(document.getElementById("fp-change").value,      0, 100);
      fpCount     = clamp(document.getElementById("fp-count").value,       0, 100);
      jpegQuality = clamp(document.getElementById("jpeg-quality").value,   5, 100);
      minWidth    = clamp(document.getElementById("min-width").value,      0, 320);
      minHeight   = clamp(document.getElementById("min-height").value,     0, 320);
      minAsArea   = document.getElementById("min-as-area").checked;
      updateElements();

      var csv = csvFromConfig();
      postData(configSaveUrl, "text/plain", csv)
        .then(console.log("Config saved:", csv))
        .catch(error => console.error("Failed to save config: ", error));
    }

    //Request config reset from device
    function resetConfig() {
      getData(configResetUrl, false)
        .then(config => {
          console.log("Config reset loaded");
          updateDocument(config.split(","));
        })
        .catch(error => console.error("Failed to reset load config: ", error));
    }

    //Download local config to file as csv
    function downloadConfig() {
      var csv = csvFromConfig();
      var blob = new Blob([csv], { type: "text/plain" }); //Create a blob with the text
      var a = document.createElement("a");                //Create an anchor element and set the URL to the blob
      a.href = URL.createObjectURL(blob);
      a.download = "config.csv";    //Define file name
      document.body.appendChild(a); //Append the anchor to the document
      a.click();                    //Trigger the download by simulating a click
      document.body.removeChild(a); //Clean up by removing the element
    }

    //Upload a csv file as config
    function uploadConfig() {
      var fileInput = document.getElementById("file-input");
      var file = fileInput.files[0]; //Get the file
      var reader = new FileReader();

      reader.onload = function (e) {
        var csv = e.target.result;
        console.log(csv);
        updateDocument(csv.split(","));
      };

      reader.onerror = function (e) {
        //Handle errors
        console.error("File could not be loaded: " + e.target.error.code);
      };

      reader.readAsText(file); //Read the file as text

    }


    //Function to toggle cells
    function toggleCell(i, j) {
      if (toggleDir)
        mask.elem[i][j].classList.add("toggled");
      else
        mask.elem[i][j].classList.remove("toggled");

      mask.val[i][j] = toggleDir;
    }

    //Un/Hide the mask
    function toggleMask() {
      var mask = document.getElementById("gridCanvas");
      if (mask.style.display == "none")
        mask.style.display = "block"; //The mask was hidden, now show it
      else
        mask.style.display = "none"; //The mask is visible, now hide it
    }

    function resetMask() {
      toggleDir = 0;
      for (let i = 0; i < maskSize; i++) {
        for (let j = 0; j < maskSize; j++) {
          toggleCell(i, j);
        }
      }
    }

    function resizeMask() {
      maskSize = clamp(document.getElementById("mask-size").value, 2, 80);
      updateElements();
      createMask();
      resetMask();
    }

    //Function to create mask cells
    function createMask() {
      const gridCanvas = document.getElementById("gridCanvas");

      //remove cells if there are any
      const cells = document.getElementsByClassName("cell");
      while(cells.length) {
        cells[0].parentNode.removeChild(cells[0]);
      }

      //create the mask
      mask = {
        "val":  Array.from({ length: maskSize }, () => new Array(maskSize).fill(0)),
        "elem": Array.from({ length: maskSize }, () => new Array(maskSize).fill(null))
      };

      //create the cells
      for (let i = 0; i < maskSize; i++) {
        for (let j = 0; j < maskSize; j++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.dataset.toggled = false; //Custom attribute to track state
          cell.style.width  = previewSize / maskSize + "px";
          cell.style.height = previewSize / maskSize + "px";

          cell.addEventListener("mousedown", function (event) {
            mouseIsDown = true;
            toggleDir = mask.val[i][j] ? 0 : 1;
            toggleCell(i, j);
            event.preventDefault(); //Prevent text selection
          });

          cell.addEventListener("mouseenter", function () {
            if (mouseIsDown)
              toggleCell(i, j);
          });

          cell.addEventListener("mouseup", function () {
            mouseIsDown = false;
          });

          gridCanvas.appendChild(cell);
          mask.elem[i][j] = cell;
        }
      }
    }

    //Reset the toggle tracking on mouseup anywhere in the window
    window.addEventListener("mouseup", function () {
      mouseIsDown = false;
      let cells = document.getElementsByClassName("cell");
      for (let cell of cells)
        cell.dataset.toggled = false; //Reset all cells state
    });


    function resizePreview() {
      previewSize = clamp(document.getElementById("preview-size").value, 200, 1000);
      updateElements();

      document.getElementById("gridCanvas").style.width  = previewSize + "px";
      document.getElementById("gridCanvas").style.height = previewSize + "px";
      document.getElementById("stream").width  = previewSize;
      document.getElementById("stream").height = previewSize;

      var cells = document.getElementsByClassName("cell");
      for (var i = 0; i < cells.length; i++) {
        cells[i].style.width  = previewSize / maskSize + "px";
        cells[i].style.height = previewSize / maskSize + "px";
      }
    }

    //faster image reading using objecturl instead of fileread
    async function updatePreview() {
      while (1) {
        try {
          let arrayBuffer = await fetch(imgUrl).then(resp => resp.arrayBuffer()); //Get image with status
          let jpegBuffer  = arrayBuffer.slice(0, arrayBuffer.byteLength - 1);      //Slice jpeg from the data
          let imageBlob   = new Blob([jpegBuffer], { type: "image/jpeg" });
          let imgElem     = document.getElementById("stream");

          //Revoke the previous object URL to avoid memory leaks
          if (imgElem.src.startsWith("blob:"))
            URL.revokeObjectURL(imgElem.src);

          imgElem.src    = URL.createObjectURL(imageBlob);
          imgElem.width  = previewSize;
          imgElem.height = previewSize;

          //Get the last byte as status
          let statusView = new DataView(arrayBuffer);
          let status = statusView.getInt8(arrayBuffer.byteLength - 1);
          document.getElementById("status-field").value = status;
        } catch (reason) {
          console.error("Error while fetching image: " + reason.toString());
        }

        //Adjust this value as needed for performance and update frequency
        await sleep(100);
      }
    }

    function sleep(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }
  </script>

</body>

</html>