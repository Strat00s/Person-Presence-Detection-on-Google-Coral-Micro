<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <style>
    body {
      display: flex;
      margin: 0;
      padding: 0;
      height: 100vh;
    }

    #video-container {
      flex: 1;
      background-color: #f0f0f0;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #config-container {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .config-group {
      border-bottom: 2px solid #ddd;
      padding: 10px 0;
      justify-content: left;
      column-gap: 20px;
    }

    .config-group:last-child {
      border-bottom: none;
    }

    .input-wrapper {
      position: relative;
      display: inline-block;
    }

    .input-wrapper input {
      text-align: right;
      padding-right: 20px;
      /* Make space for the symbol */
    }

    .input-wrapper span {
      position: absolute;
      right: 5px;
      /* Adjust based on padding and preferences */
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      /* Makes it non-interactive */
    }


    #gridCanvas {
      display: "none";
      position: absolute;
      width: 500px;
      height: 500px;
    }

    .cell {
      width: 15.6px;
      /* 320px / 32 cells */
      height: 15.6px;
      float: left;
      border: 1px solid #dddddd57;
      box-sizing: border-box;
      cursor: pointer;
    }

    .toggled {
      background-color: rgba(255, 0, 0, 0.338);
    }
  </style>


  <title>Camera grid mask</title>
</head>

<body id="body" onload="start()">

  <div id="video-container">
    <img id="stream" alt="Image cannot be displayed" />
    <div id="gridCanvas"></div>
  </div>

  <div id="config-container">

    <div class="config-group">
      <label for="image-rotation" class="input-label">Device rotation:</label>
      <select name="image-rotation" id="image-rotation">
        <option value=0>0째</option>
        <option value=90>90째</option>
        <option value=180>180째</option>
        <option value=270>270째</option>
      </select>
    </div>

    <div class="config-group">
      <label for="jpeg-quality">Preview quality:</label>
      <input type="number" id="jpeg-quality" name="jpeg-quality" size="3" maxlength="3" min="5" max="100">
      <label for="preview-size">Preview size:</label>
      <div class="input-wrapper">
        <input type="number" id="preview-size" name="preview-size" onchange="resizePreview()" size="4" maxlength="4" min="200" max="1000">
        <span>px</span>
      </div>
    </div>

    <div class="config-group">
      <label for="mask-size">Mask size:</label>
      <div class="input-wrapper">
        <input type="number" id="mask-size" name="mask-size" onchange="resizeMask()" size="3" maxlength="3" min="2" max="80">
        <span>c</span>
      </div>
      <label for="mask-thresh">Mask uncovered threshold:</label>
      <div class="input-wrapper">
        <input type="number" id="mask-thresh" name="mask-thresh" size="3" maxlength="3" min="0" max="100">
        <span>%</span>
      </div>
      <button id="toggleMaskBtn" onclick="toggleMask()">Toggle mask</button>
      <button id="resetMaskBtn" onclick="resetMask()">Reset mask</button>
    </div>

    <div class="config-group">
      <label for="det-thresh">Detection threshold:</label>
      <div class="input-wrapper">
        <input type="number" id="det-thresh" name="det-thresh" size="3" maxlength="3" min="0" max="100">
        <span>%</span>
      </div>

      <label for="iou-thresh">Overlap threshold:</label>
      <div class="input-wrapper">
        <input type="number" id="iou-thresh" name="iou-thresh" size="3" maxlength="3" min="0" max="100">
        <span>%</span>
      </div>
    </div>

    <div class="config-group">
      <label for="fp-change">False-positive change threshold:</label>
      <div class="input-wrapper">
        <input type="number" id="fp-change" name="fp-change" size="3" maxlength="3" min="0" max="100" />
        <span>%</span>
      </div>

      <label for="fp-count">False-positive count threshold:</label>
      <div class="input-wrapper">
        <input type="number" id="fp-count" name="fp-count" size="3" maxlength="3" min="0" max="100">
        <span>%</span>
      </div>
    </div>

    <div class="config-group">
      <button id="saveToDevice" onclick="saveConfig()">Save config</button>
      <button id="loadFromDevice" onclick="loadConfig()">Load config</button>
      <button id="resetFromDevice" onclick="resetConfig()">Reset config</button>
    </div>

    <div class="config-group">
      <button id="saveToFileBtn" onclick="downloadConfig()">Download configuration</button>
      <input type="file" id="file-input" style="display: none;" onchange="uploadConfig()" />
      <button id="loadFromFileBtn" onclick="document.getElementById('file-input').click()">Upload configuration</button>
    </div>

    <div class="config-group">
      <label for="status-field">Status:</label>
      <input type="number" id="status-field" name="status-field" size="1" maxlength="1" disabled>
    </div>

  </div>


  <script>
    const imgUrl = "/camera_stream"; //get
    const configSaveUrl = "/config_save"; //get set
    const configLoadUrl = "/config_load"; //get set
    const configResetUrl = "/config_reset";
    const statusUrl = "/detection_status";

    var previewSize = 500;
    var maskSize = 32; //current mask size (cell count per dimension)
    var maskThresh = 50;
    var rotation = 270;
    var detThresh = 50;
    var iouThresh = 50;
    var fpChange = 40;
    var fpCount = 5;
    var jpegQuality = 75;



    //Initialize grid and mask data structure
    //let mask = [new Array(maskSize), new Array(maskSize)];
    let mask;
    let mouseIsDown = false; //Tracks if the mouse is pressed down
    let toggleDir = 0;


    //start everything important on load
    function start() {
      document.getElementById("mask-size").value = maskSize;
      document.getElementById("mask-thresh").value = maskThresh;
      document.getElementById("image-rotation").value = rotation;
      document.getElementById("det-thresh").value = detThresh;
      document.getElementById("iou-thresh").value = iouThresh;
      document.getElementById("fp-change").value = fpChange;
      document.getElementById("fp-count").value = fpCount;
      document.getElementById("jpeg-quality").value = jpegQuality;
      document.getElementById("preview-size").value = previewSize;
      loadConfig();
      //createGrid();
      updatePreview();
    }


    function postData(url, type, data) {
      return fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": type,
        },
        body: data
      })
        .then(response => {
          if (!response.ok) {
            console.error("Post not OK (", response.status, "): ", response.statusText);
            throw new Error("Post not ok");
          }
          else
            console.log("Post OK (", response.status, ")");
          return response.text();
        })
        .then(body => {
          console.log("Success: ", body)
        })
        .catch(error => console.error("Error: ", error))
    }

    function getData(url, isJson) {
      return fetch(url)
        .then(response => {
          //Check if the response is ok (status code 200-299)
          if (!response.ok) {
            console.error("Get not OK (", response.status, "): ", response.statusText);
            return Promise.reject("Get not OK");
          }
          else
            console.log("Get OK (", response.status, ")");
          return isJson ? response.json() : response.text();
        })
        .catch(error => {
          console.error("Get error: ", error)
          return Promise.reject(error);
        });
    }


    function updateDocument(values) {
      if (values.length < 9)
        throw Error("Invalid csv length of ", values.length);
      maskSize = values[0];
      createMask();
      maskThresh = values[1];
      for (var i = 0; i < maskSize; i++) {
        for (var ii = 0; ii < maskSize; ii++) {
          mask.val[i][ii] = Number(values[2][i * maskSize + ii]);
          toggleDir = mask.val[i][ii];
          toggleCell(i, ii);
        }
      }
      rotation = values[3];
      detThresh = values[4];
      iouThresh = values[5];
      fpChange = values[6];
      fpCount = values[7];
      jpegQuality = values[8];

      document.getElementById("mask-size").value = maskSize;
      document.getElementById("mask-thresh").value = maskThresh;
      document.getElementById("image-rotation").value = rotation;
      document.getElementById("det-thresh").value = detThresh;
      document.getElementById("iou-thresh").value = iouThresh;
      document.getElementById("fp-change").value = fpChange;
      document.getElementById("fp-count").value = fpCount;
      document.getElementById("jpeg-quality").value = jpegQuality;
    }

    function loadConfig() {
      getData(configLoadUrl, false)
        .then(config => {
          console.log("Config loaded");
          updateDocument(config.split(","));
        })
        .catch(error => console.error("Failed to load config: ", error));
    }

    function buildCsvString() {
      let maskVal = "";
      mask.val.forEach(row => {
        row.forEach(item => {
          maskVal += item.toString();
        })
      })
      var csv = maskSize.toString() + ",";
      csv += maskThresh.toString() + ",";
      csv += maskVal + ",";
      csv += rotation.toString() + ",";
      csv += detThresh.toString() + ",";
      csv += iouThresh.toString() + ",";
      csv += fpChange.toString() + ",";
      csv += fpCount.toString() + ",";
      csv += jpegQuality.toString();
      return csv;
    }

    function saveConfig() {
      maskSize = document.getElementById("mask-size").value;
      maskThresh = document.getElementById("mask-thresh").value;
      rotation = document.getElementById("image-rotation").value;
      detThresh = document.getElementById("det-thresh").value;
      iouThresh = document.getElementById("iou-thresh").value;
      fpChange = document.getElementById("fp-change").value;
      fpCount = document.getElementById("fp-count").value;
      jpegQuality = document.getElementById("jpeg-quality").value;

      var csv = buildCsvString();
      postData(configSaveUrl, "text/plain", csv)
        .then(console.log("Config saved:", csv))
        .catch(error => console.error("Failed to save config: ", error));
    }

    function resetConfig() {
      getData(configResetUrl, false)
        .then(config => {
          console.log("Config reset loaded");
          updateDocument(config.split(","));
        })
        .catch(error => console.error("Failed to reset load config: ", error));
    }

    function downloadConfig() {
      var csv = buildCsvString();
      var blob = new Blob([csv], { type: "text/plain" }); //Create a blob with the text
      var a = document.createElement("a");                 //Create an anchor element and set the URL to the blob
      a.href = URL.createObjectURL(blob);
      a.download = "config.csv";                           //Define file name
      document.body.appendChild(a);                        //Append the anchor to the document
      a.click();                                           //Trigger the download by simulating a click
      document.body.removeChild(a);                        //Clean up by removing the element
    }

    function uploadConfig() {
      var fileInput = document.getElementById("file-input");
      var file = fileInput.files[0]; //Get the file
      var reader = new FileReader();

      reader.onload = function (e) {
        var csv = e.target.result;
        console.log(csv);
        updateDocument(csv.split(","));
      };

      reader.onerror = function (e) {
        //Handle errors
        console.error("File could not be loaded: " + e.target.error.code);
      };

      reader.readAsText(file); //Read the file as text

    }


    //Function to toggle cells
    function toggleCell(i, j) {
      if (toggleDir)
        mask.elem[i][j].classList.add("toggled");//cell.classList.add("toggled");
      else
        mask.elem[i][j].classList.remove("toggled");//cell.classList.remove("toggled");

      mask.val[i][j] = toggleDir;
    }


    function toggleMask() {
      var grid = document.getElementById("gridCanvas");
      if (grid.style.display == "none")
        grid.style.display = "block"; //The grid was hidden, now show it
      else
        grid.style.display = "none"; //The grid is visible, now hide it
    }

    function resetMask() {
      toggleDir = 0;
      for (let i = 0; i < maskSize; i++) {
        for (let j = 0; j < maskSize; j++) {
          toggleCell(i, j);
        }
      }
    }

    function resizeMask() {
      maskSize = document.getElementById("mask-size").value;
      createMask();
      resetMask();
    }

    //Function to create grid cells
    function createMask() {
      const gridCanvas = document.getElementById("gridCanvas");

      //remove cells if there are any
      const cells = document.getElementsByClassName("cell");
      while(cells.length) {
        cells[0].parentNode.removeChild(cells[0]);
      }

      //create the mask
      mask = {
        "val": Array.from({ length: maskSize }, () => new Array(maskSize).fill(0)),
        "elem": Array.from({ length: maskSize }, () => new Array(maskSize).fill(null))
      };

      //create the cells
      for (let i = 0; i < maskSize; i++) {
        for (let j = 0; j < maskSize; j++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.dataset.toggled = false; //Custom attribute to track state
          cell.style.width = previewSize / maskSize + "px";
          cell.style.height = previewSize / maskSize + "px";

          cell.addEventListener("mousedown", function (event) {
            mouseIsDown = true;
            toggleDir = mask.val[i][j] ? 0 : 1;
            toggleCell(i, j);
            event.preventDefault(); //Prevent text selection
          });

          cell.addEventListener("mouseenter", function () {
            if (mouseIsDown)
              toggleCell(i, j);
          });

          cell.addEventListener("mouseup", function () {
            mouseIsDown = false;
          });

          gridCanvas.appendChild(cell);
          mask.elem[i][j] = cell;
        }
      }
    }

    //Reset the toggle tracking on mouseup anywhere in the window
    window.addEventListener("mouseup", function () {
      mouseIsDown = false;
      let cells = document.getElementsByClassName("cell");
      for (let cell of cells)
        cell.dataset.toggled = false; //Reset all cells" state
    });


    function resizePreview() {
      previewSize = document.getElementById("preview-size").value;
      if (previewSize < 200) {
        previewSize = 200;
        document.getElementById("preview-size").value = 200;
      }
      document.getElementById("gridCanvas").style.width = previewSize + "px";
      document.getElementById("gridCanvas").style.height = previewSize + "px";
      document.getElementById("stream").width = previewSize;
      document.getElementById("stream").height = previewSize;

      var cells = document.getElementsByClassName("cell");
      for (var i = 0; i < cells.length; i++) {
        cells[i].style.width = previewSize / maskSize + "px";
        cells[i].style.height = previewSize / maskSize + "px";
      }
    }

    //faster image reading using objecturl instead of fileread
    async function updatePreview() {
      while (1) {
        try {
          let arrayBuffer = await fetch(imgUrl).then(resp => resp.arrayBuffer()); //Get image with status
          let jpegBuffer = arrayBuffer.slice(0, arrayBuffer.byteLength - 1);      //Slice jpeg from the data
          let imageBlob = new Blob([jpegBuffer], { type: "image/jpeg" });
          let imgElem = document.getElementById("stream");

          //Revoke the previous object URL to avoid memory leaks
          if (imgElem.src.startsWith("blob:"))
            URL.revokeObjectURL(imgElem.src);

          imgElem.src = URL.createObjectURL(imageBlob);
          imgElem.width = previewSize;
          imgElem.height = previewSize;

          //Get the last byte as status
          let extraByteView = new DataView(arrayBuffer);
          let extraByteSigned = extraByteView.getInt8(arrayBuffer.byteLength - 1);
          document.getElementById("status-field").value = extraByteSigned;
        } catch (reason) {
          console.error("Error while fetching image: " + reason.toString());
        }

        //Adjust this value as needed for performance and update frequency
        await sleep(100);
      }
    }

    function sleep(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    //Call createGrid on page load
    //window.onload = createGrid;
  </script>

</body>

</html>